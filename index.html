<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A√±o Nuevo 2025‚Äì2026</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f8ff; margin:0; padding:20px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { text-align:center; color:#0a4d8c; margin: 10px 0 25px; }
    .card { background:#fff; border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin:18px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { cursor:pointer; border:0; border-radius:10px; padding:10px 14px; font-weight:700; }
    .btn-main { background:#0a4d8c; color:#fff; }
    .btn-del { background:#c0392b; color:#fff; }
    .hint { color:#444; margin-top:10px; }
    #status { margin-top:10px; color:#0a4d8c; font-weight:700; }
    #gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap:14px; margin-top:10px; }
    .tile { background:#fff; border-radius:14px; overflow:hidden; box-shadow:0 8px 22px rgba(0,0,0,.08); }
    .tile img, .tile video { width:100%; height:160px; object-fit:cover; display:block; background:#eee; }
    .tile .meta { padding:10px; display:flex; flex-direction:column; gap:8px; }
    .small { font-size:12px; color:#555; word-break:break-word; }
    a { color:#0a4d8c; text-decoration:none; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üå¥ A√±o Nuevo 2025‚Äì2026 üåä</h1>

    <div class="card">
      <h2>üì∏ Subir fotos o videos del viaje</h2>
      <div class="row">
        <input type="file" id="photoInput" accept="image/*,video/*" />
        <button id="uploadBtn" class="btn-main">Subir</button>
      </div>
      <div id="status"></div>
      <div class="hint">Tip: si sub√≠s algo mal, vas a ver un bot√≥n üóë ‚ÄúBorrar‚Äù en TU celu/PC (solo vos lo pod√©s borrar).</div>
    </div>

    <div class="card">
      <h2>üñºÔ∏è Galer√≠a</h2>
      <div id="gallery"></div>
    </div>
  </div>

  <script>
    // üëá Peg√° ac√° tu URL del Web App (termina en /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbxYdUAwsRO3RzPoPndLxc3dIRF71GBOsBU1U2r5dbrlIYnpjnJkr54ldlhpsEPVyOKbpg/exec";

    const photoInput = document.getElementById("photoInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("status");
    const gallery = document.getElementById("gallery");

    // Guardamos tokens por archivo en el navegador (solo para el que sube)
    const TOKENS_KEY = "deleteTokens_v1";
    function loadTokens() {
      try { return JSON.parse(localStorage.getItem(TOKENS_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveTokens(tokens) {
      localStorage.setItem(TOKENS_KEY, JSON.stringify(tokens));
    }

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const s = String(reader.result);
          const base64 = s.split(",")[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function uploadPhoto() {
      const file = photoInput.files && photoInput.files[0];
      if (!file) {
        statusEl.textContent = "Eleg√≠ un archivo primero üôÇ";
        return;
      }

      statusEl.textContent = "Subiendo...";
      uploadBtn.disabled = true;

      try {
        const data = await toBase64(file);

        const body = new URLSearchParams();
        body.set("action", "upload");
        body.set("data", data);
        body.set("mimeType", file.type || "application/octet-stream");
        body.set("fileName", file.name || ("archivo_" + Date.now()));

        const res = await fetch(API_URL, { method: "POST", body });
        const json = await res.json();

        if (!json.ok) throw new Error(json.error || "No se pudo subir");

        // guardo token de borrado local
        const tokens = loadTokens();
        tokens[json.id] = json.deleteToken;
        saveTokens(tokens);

        statusEl.textContent = "‚úÖ Subido!";

        photoInput.value = "";
        await loadGallery();

      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå Error: " + (err.message || err);
      } finally {
        uploadBtn.disabled = false;
      }
    }

    async function deleteFile(fileId) {
      const tokens = loadTokens();
      const token = tokens[fileId];

      if (!token) {
        alert("En este dispositivo no est√° la llave para borrar ese archivo (solo puede borrar quien subi√≥).");
        return;
      }

      if (!confirm("¬øSeguro que quer√©s borrar este archivo?")) return;

      try {
        statusEl.textContent = "Borrando...";
        const body = new URLSearchParams();
        body.set("action", "delete");
        body.set("id", fileId);
        body.set("token", token);

        const res = await fetch(API_URL, { method: "POST", body });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "No se pudo borrar");

        // borrar token local
        delete tokens[fileId];
        saveTokens(tokens);

        statusEl.textContent = "üóëÔ∏è Borrado!";
        await loadGallery();

      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå Error al borrar: " + (err.message || err);
      }
    }

    function makeTile(p) {
      const tile = document.createElement("div");
      tile.className = "tile";

      // Visual: si es video intentamos video directo; si no, imagen miniatura
      let media;
      if (p.isVideo) {
        media = document.createElement("video");
        media.controls = true;
        media.src = p.directUrl; // si alg√∫n navegador lo bloquea, al menos ten√©s el link "Ver"
      } else {
        media = document.createElement("img");
        media.src = p.thumb;
        media.alt = p.name || "foto";
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const a = document.createElement("a");
      a.href = p.viewUrl;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = "Ver en Drive";

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = (p.name || "") + (p.created ? (" ‚Ä¢ " + new Date(p.created).toLocaleString()) : "");

      // Bot√≥n borrar solo si tengo token en ESTE navegador
      const tokens = loadTokens();
      if (tokens[p.id]) {
        const del = document.createElement("button");
        del.className = "btn-del";
        del.textContent = "üóë Borrar (lo sub√≠ yo)";
        del.onclick = () => deleteFile(p.id);
        meta.appendChild(del);
      }

      meta.appendChild(a);
      meta.appendChild(small);

      tile.appendChild(media);
      tile.appendChild(meta);
      return tile;
    }

    async function loadGallery() {
      try {
        gallery.innerHTML = "";
        const res = await fetch(API_URL);
        const json = await res.json();

        if (!json.ok) throw new Error(json.error || "No se pudo cargar galer√≠a");

        (json.photos || []).forEach(p => {
          gallery.appendChild(makeTile(p));
        });

        if ((json.photos || []).length === 0) {
          gallery.textContent = "Todav√≠a no hay fotos/videos üôÇ";
        }
      } catch (err) {
        console.error(err);
        gallery.textContent = "Error al cargar galer√≠a: " + (err.message || err);
      }
    }

    uploadBtn.addEventListener("click", uploadPhoto);
    loadGallery();
  </script>
</body>
</html>
