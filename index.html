const FOLDER_ID = 1AiGB6BBrUGEB8QnmdQ19wycFRdcMM6UE;  // ← reemplazar

function doPost(e) {
  try {
    const folder = DriveApp.getFolderById(FOLDER_ID);

    const data = e.parameter.data;
    const mimeType = e.parameter.mimeType;
    const fileName = e.parameter.fileName || ('foto_' + Date.now() + '.jpg');

    const bytes = Utilities.base64Decode(data);
    const blob = Utilities.newBlob(bytes, mimeType, fileName);

    const file = folder.createFile(blob);

    // Hacer público con link
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    const id = file.getId();
    const publicUrl = 'https://drive.google.com/uc?export=view&id=' + id;

    const res = { ok: true, url: publicUrl };

    return ContentService
      .createTextOutput(JSON.stringify(res))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    const res = { ok: false, error: err.toString() };
    return ContentService
      .createTextOutput(JSON.stringify(res))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const folder = DriveApp.getFolderById(FOLDER_ID);
  const files = folder.getFiles();
  const list = [];

  while (files.hasNext()) {
    const f = files.next();
    const id = f.getId();
    const url = 'https://drive.google.com/uc?export=view&id=' + id;

    list.push({
      url: url,
      name: f.getName(),
      created: f.getDateCreated()
    });
  }

  return ContentService
    .createTextOutput(JSON.stringify({ ok: true, photos: list }))
    .setMimeType(ContentService.MimeType.JSON);
}
