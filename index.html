<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A√±o Nuevo 2025‚Äì2026</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f3f6fb; margin:0; padding:20px; }
    .header { text-align:center; margin-bottom:20px; }
    .header h1 { margin:0; font-size:34px; color:#0a4d8c; }
    .card { background:#fff; border-radius:16px; padding:18px; margin:16px auto; max-width:980px; box-shadow:0 6px 24px rgba(0,0,0,.08); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn { background:#0a4d8c; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-danger { background:#b42318; }
    .status { margin-top:10px; font-size:14px; color:#333; }
    .grid { display:flex; flex-wrap:wrap; gap:14px; margin-top:12px; }
    .tile { width:220px; background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:10px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    .thumb { width:100%; height:160px; object-fit:cover; border-radius:10px; background:#f2f2f2; }
    .name { font-weight:700; margin:8px 0 6px; font-size:13px; word-break:break-word; }
    .meta { font-size:12px; color:#555; margin-bottom:8px; }
    a { color:#0a4d8c; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .small { font-size:12px; color:#666; }
  </style>
</head>

<body>
  <div class="header">
    <h1>üå¥ A√±o Nuevo 2025‚Äì2026 üåä</h1>
    <div class="small">Subimos fotos/videos a una carpeta compartida (Drive) y los vemos ac√°.</div>
  </div>

  <div class="card">
    <h2>üì∏ Subir fotos o videos</h2>
    <div class="row">
      <input id="fileInput" type="file" accept="image/*,video/*" />
      <button id="uploadBtn" class="btn">Subir</button>
      <button id="refreshBtn" class="btn" type="button">Actualizar galer√≠a</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h2>üñºÔ∏è Galer√≠a</h2>
    <div id="gallery" class="grid"></div>
  </div>

  <script>
    // ‚úÖ Peg√° ac√° tu Web App de Apps Script (la que termina en /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbwbgKBP_ZihU7spyYQBtdDTYmLrK2krZfDN3BiPw_TtocV1zz2oO2SsKnbwy3mfWWcE0A/exec";

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const statusEl = document.getElementById("status");
    const galleryEl = document.getElementById("gallery");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch { return ""; }
    }

    function makeTile(p) {
      const tile = document.createElement("div");
      tile.className = "tile";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name || "";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = (p.isVideo ? "üé¨ Video" : "üñºÔ∏è Foto") + (p.created ? " ‚Ä¢ " + fmtDate(p.created) : "");

      let preview;
      if (p.isVideo) {
        preview = document.createElement("video");
        preview.src = p.viewUrl; // para video usamos viewUrl (Drive)
        preview.controls = true;
        preview.style.width = "100%";
        preview.style.borderRadius = "10px";
      } else {
        preview = document.createElement("img");
        preview.className = "thumb";
        preview.src = p.thumb; // miniatura
        preview.loading = "lazy";
      }

      const linkRow = document.createElement("div");
      linkRow.style.marginTop = "8px";

      const a = document.createElement("a");
      a.href = p.viewUrl;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = "Ver en Drive";

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-danger";
      delBtn.style.marginLeft = "10px";
      delBtn.textContent = "Borrar";
      delBtn.onclick = async () => {
        const ok = confirm("¬øSeguro que quer√©s borrar este archivo? (foto/video)");
        if (!ok) return;
        delBtn.disabled = true;
        try {
          const res = await fetch(API_URL + "?delete=1&id=" + encodeURIComponent(p.id));
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "No se pudo borrar");
          setStatus("‚úÖ Borrado.");
          await loadGallery();
        } catch (e) {
          console.error(e);
          setStatus("‚ùå Error al borrar: " + (e.message || e));
        } finally {
          delBtn.disabled = false;
        }
      };

      linkRow.appendChild(a);
      linkRow.appendChild(delBtn);

      tile.appendChild(name);
      tile.appendChild(meta);
      tile.appendChild(preview);
      tile.appendChild(linkRow);

      return tile;
    }

    async function loadGallery() {
      setStatus("Cargando galer√≠a...");
      galleryEl.innerHTML = "";
      try {
        const res = await fetch(API_URL);
        const json = await res.json();

        if (!json.ok) throw new Error(json.error || "No se pudo cargar galer√≠a");

        const list = (json.photos || []);
        if (list.length === 0) {
          setStatus("Todav√≠a no hay fotos/videos üôÇ");
          return;
        }

        list.forEach(p => galleryEl.appendChild(makeTile(p)));
        setStatus("‚úÖ Galer√≠a cargada: " + list.length + " archivos.");
      } catch (e) {
        console.error(e);
        setStatus("‚ùå Error al cargar: " + (e.message || e));
      }
    }

    async function uploadFile() {
      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        setStatus("Eleg√≠ un archivo primero.");
        return;
      }

      uploadBtn.disabled = true;
      setStatus("Subiendo... (no cierres la pesta√±a)");

      try {
        const base64 = await toBase64(file);

        const form = new URLSearchParams();
        form.set("fileName", file.name);
        form.set("mimeType", file.type || "application/octet-stream");
        form.set("data", base64);

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: form.toString()
        });

        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "No se pudo subir");

        setStatus("‚úÖ Subido: " + (json.name || file.name));
        fileInput.value = "";
        await loadGallery();

      } catch (e) {
        console.error(e);
        setStatus("‚ùå Error al subir: " + (e.message || e));
      } finally {
        uploadBtn.disabled = false;
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // reader.result = "data:...;base64,XXXX"
          const s = String(reader.result || "");
          const comma = s.indexOf(",");
          resolve(comma >= 0 ? s.slice(comma + 1) : s);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    uploadBtn.addEventListener("click", uploadFile);
    refreshBtn.addEventListener("click", loadGallery);

    loadGallery();
  </script>
</body>
</html>
