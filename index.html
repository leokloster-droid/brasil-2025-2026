<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A√±o Nuevo 2025‚Äì2026</title>

  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { font-family: Arial, sans-serif; background:#f3f6fb; margin:0; padding:20px; }
    .header { text-align:center; margin-bottom:20px; }
    .header h1 { margin:0; font-size:34px; color:#0a4d8c; }
    .card { background:#fff; border-radius:16px; padding:18px; margin:16px auto; max-width:980px; box-shadow:0 6px 24px rgba(0,0,0,.08); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn { background:#0a4d8c; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-danger { background:#b42318; }
    .status { margin-top:10px; font-size:14px; color:#333; }
    .grid { display:flex; flex-wrap:wrap; gap:14px; margin-top:12px; }
    .tile { width:220px; background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:10px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    .thumb { width:100%; height:160px; object-fit:cover; border-radius:10px; background:#f2f2f2; }
    .name { font-weight:700; margin:8px 0 6px; font-size:13px; word-break:break-word; }
    .meta { font-size:12px; color:#555; margin-bottom:8px; }
    .small { font-size:12px; color:#666; }
    a { color:#0a4d8c; text-decoration:none; }
    a:hover { text-decoration:underline; }
    #map { height: 420px; border-radius: 14px; overflow:hidden; border: 1px solid #e6e6e6; }
    .list { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .item { background:#f8fbff; border:1px solid #e6eef9; padding:10px; border-radius:12px; font-size:14px; }
    .pill { display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#e8f1ff; color:#0a4d8c; font-weight:700; margin-left:6px;}
    input[type="text"]{ padding:10px 12px; border-radius:10px; border:1px solid #d6d6d6; min-width:240px; }
  </style>
</head>

<body>
  <div class="header">
    <h1>üå¥ A√±o Nuevo 2025‚Äì2026 üåä</h1>
    <div class="small">Fotos + videos + mapa + ubicaci√≥n en vivo (guardada cuando apret√°s el bot√≥n).</div>
  </div>

  <!-- SUBIR -->
  <div class="card">
    <h2>üì∏ Subir fotos o videos</h2>
    <div class="row">
      <input id="fileInput" type="file" accept="image/*,video/*" />
      <button id="uploadBtn" class="btn">Subir</button>
      <button id="refreshBtn" class="btn" type="button">Actualizar galer√≠a</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- GALERIA -->
  <div class="card">
    <h2>üñºÔ∏è Galer√≠a <span class="pill" id="countPill">0</span></h2>
    <div id="gallery" class="grid"></div>
  </div>

  <!-- MAPA -->
  <div class="card">
    <h2>üó∫Ô∏è Mapa del recorrido</h2>
    <div class="row">
      <input id="whoInput" type="text" placeholder="Tu nombre (ej: Leo)" />
      <button id="saveLocBtn" class="btn">üìç Guardar mi ubicaci√≥n</button>
      <button id="reloadMapBtn" class="btn">üîÑ Actualizar mapa</button>
    </div>
    <div class="small" style="margin-top:8px;">
      Tip: el GPS se guarda cuando apret√°s el bot√≥n. Si no acept√°s permisos, no puede guardar.
    </div>

    <div style="margin-top:14px;">
      <div id="map"></div>
      <div class="list" id="pointsList"></div>
      <div id="mapStatus" class="status"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ‚úÖ Peg√° ac√° tu Web App de Apps Script (la que termina en /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbwWDly1_r5N1wIf_oGShwG7J0HAQIQIuJy7L5Qy9EdhS8o27nrIFyKj8E7wT2AJshTvHA/exec";

    // ---- UI ----
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const statusEl = document.getElementById("status");
    const galleryEl = document.getElementById("gallery");
    const countPill = document.getElementById("countPill");

    const whoInput = document.getElementById("whoInput");
    const saveLocBtn = document.getElementById("saveLocBtn");
    const reloadMapBtn = document.getElementById("reloadMapBtn");
    const pointsList = document.getElementById("pointsList");
    const mapStatus = document.getElementById("mapStatus");

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setMapStatus(msg) { mapStatus.textContent = msg || ""; }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return ""; }
    }

    // ---------------------------
    //  GALER√çA (fotos/videos)
    // ---------------------------
    function makeTile(p) {
      const tile = document.createElement("div");
      tile.className = "tile";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name || "";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = (p.isVideo ? "üé¨ Video" : "üñºÔ∏è Foto") + (p.created ? " ‚Ä¢ " + fmtDate(p.created) : "");

      let preview;
      if (p.isVideo) {
        preview = document.createElement("video");
        preview.src = p.viewUrl;
        preview.controls = true;
        preview.style.width = "100%";
        preview.style.borderRadius = "10px";
      } else {
        preview = document.createElement("img");
        preview.className = "thumb";
        preview.src = p.thumb;
        preview.loading = "lazy";
      }

      const linkRow = document.createElement("div");
      linkRow.style.marginTop = "8px";

      const a = document.createElement("a");
      a.href = p.viewUrl;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = "Ver en Drive";

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-danger";
      delBtn.style.marginLeft = "10px";
      delBtn.textContent = "Borrar";
      delBtn.onclick = async () => {
        const ok = confirm("¬øSeguro que quer√©s borrar este archivo? (foto/video)");
        if (!ok) return;
        delBtn.disabled = true;
        try {
          const res = await fetch(API_URL + "?delete=1&id=" + encodeURIComponent(p.id));
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "No se pudo borrar");
          setStatus("‚úÖ Borrado.");
          await loadGallery();
        } catch (e) {
          console.error(e);
          setStatus("‚ùå Error al borrar: " + (e.message || e));
        } finally {
          delBtn.disabled = false;
        }
      };

      linkRow.appendChild(a);
      linkRow.appendChild(delBtn);

      tile.appendChild(name);
      tile.appendChild(meta);
      tile.appendChild(preview);
      tile.appendChild(linkRow);
      return tile;
    }

    async function loadGallery() {
      setStatus("Cargando galer√≠a...");
      galleryEl.innerHTML = "";
      try {
        const res = await fetch(API_URL + "?mode=gallery");
        const json = await res.json();

        if (!json.ok) throw new Error(json.error || "No se pudo cargar galer√≠a");

        const list = (json.photos || []);
        countPill.textContent = String(list.length);

        if (list.length === 0) {
          setStatus("Todav√≠a no hay fotos/videos üôÇ");
          return;
        }

        list.forEach(p => galleryEl.appendChild(makeTile(p)));
        setStatus("‚úÖ Galer√≠a cargada: " + list.length + " archivos.");
      } catch (e) {
        console.error(e);
        setStatus("‚ùå Error al cargar: " + (e.message || e));
      }
    }

    async function uploadFile() {
      const file = fileInput.files && fileInput.files[0];
      if (!file) { setStatus("Eleg√≠ un archivo primero."); return; }

      uploadBtn.disabled = true;
      setStatus("Subiendo... (no cierres la pesta√±a)");

      try {
        const base64 = await toBase64(file);

        const form = new URLSearchParams();
        form.set("mode", "upload");
        form.set("fileName", file.name);
        form.set("mimeType", file.type || "application/octet-stream");
        form.set("data", base64);

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: form.toString()
        });

        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "No se pudo subir");

        setStatus("‚úÖ Subido: " + (json.name || file.name));
        fileInput.value = "";
        await loadGallery();

      } catch (e) {
        console.error(e);
        setStatus("‚ùå Error al subir: " + (e.message || e));
      } finally {
        uploadBtn.disabled = false;
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const s = String(reader.result || "");
          const comma = s.indexOf(",");
          resolve(comma >= 0 ? s.slice(comma + 1) : s);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------------------------
    //  MAPA + GPS
    // ---------------------------
    const map = L.map('map');
    const markersLayer = L.layerGroup().addTo(map);

    // OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Vista inicial (aprox Brasil)
    map.setView([-14.2350, -51.9253], 4);

    async function loadMapPoints() {
      setMapStatus("Cargando puntos...");
      markersLayer.clearLayers();
      pointsList.innerHTML = "";

      try {
        const res = await fetch(API_URL + "?mode=locations");
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "No se pudieron cargar ubicaciones");

        const pts = json.points || [];
        if (pts.length === 0) {
          setMapStatus("Todav√≠a no hay ubicaciones guardadas üôÇ");
          return;
        }

        // Orden por m√°s nuevo
        pts.sort((a,b) => new Date(b.created) - new Date(a.created));

        const bounds = [];

        pts.forEach(p => {
          const lat = Number(p.lat), lon = Number(p.lon);
          if (!isFinite(lat) || !isFinite(lon)) return;

          bounds.push([lat, lon]);

          const popup = `
            <div style="width:220px">
              <div style="font-weight:700;margin-bottom:6px">${p.who || "Alguien"} üìç</div>
              <div style="font-size:12px;color:#555;margin-bottom:8px">${p.created ? fmtDate(p.created) : ""}</div>
              <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" rel="noopener">Abrir en Google Maps</a>
            </div>
          `;

          L.marker([lat, lon]).addTo(markersLayer).bindPopup(popup);

          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `<b>${p.who || "Alguien"}</b> ‚Ä¢ ${p.created ? fmtDate(p.created) : ""}<br/>
            <a target="_blank" rel="noopener" href="https://www.google.com/maps?q=${lat},${lon}">Ver en Maps</a>`;
          pointsList.appendChild(item);
        });

        if (bounds.length) map.fitBounds(bounds, { padding: [30,30] });
        setMapStatus("‚úÖ Puntos cargados: " + pts.length);

      } catch (e) {
        console.error(e);
        setMapStatus("‚ùå Error: " + (e.message || e));
      }
    }

    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error("Tu navegador no tiene GPS."));
        navigator.geolocation.getCurrentPosition(
          pos => resolve(pos),
          err => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    async function saveMyLocation() {
      const who = (whoInput.value || "").trim() || "Alguien";

      saveLocBtn.disabled = true;
      setMapStatus("Pidiendo ubicaci√≥n al tel√©fono...");

      try {
        const pos = await getCurrentPosition();
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        setMapStatus("Guardando ubicaci√≥n...");

        const form = new URLSearchParams();
        form.set("mode", "saveLocation");
        form.set("who", who);
        form.set("lat", String(lat));
        form.set("lon", String(lon));

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: form.toString()
        });

        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "No se pudo guardar ubicaci√≥n");

        setMapStatus("‚úÖ Ubicaci√≥n guardada.");
        await loadMapPoints();

      } catch (e) {
        console.error(e);
        setMapStatus("‚ùå " + (e.message || e));
      } finally {
        saveLocBtn.disabled = false;
      }
    }

    // ---- Eventos ----
    uploadBtn.addEventListener("click", uploadFile);
    refreshBtn.addEventListener("click", loadGallery);
    reloadMapBtn.addEventListener("click", loadMapPoints);
    saveLocBtn.addEventListener("click", saveMyLocation);

    // ---- Inicio ----
    loadGallery();
    loadMapPoints();
  </script>
</body>
</html>
